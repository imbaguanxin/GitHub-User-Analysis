---
title: "Analysis"
author: "Guan.Xin | Ge.Ziqian"
date: "2019/4/8"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(jsonlite)
library(httpuv)
library(httr)
library(mongolite)
library(tidytext)
library(reshape2)
library(wordcloud)

# db for users
db.user <- mongo(collection = "users", db = "github", url = "mongodb://localhost:27123")
# db for repositories
db.repo <- mongo(collection = "repos", db = "github", url = "mongodb://localhost:27123")
# db for users we haven't fetch followers
db.userUnfetched <- mongo(collection = "unfetched", db = "github", url = "mongodb://localhost:27123")

# export mongodb to a data frame with query
mongo_to_df_query <- function(database, query){
  db_list <- database$find(query)
  df <- db_list %>% as_tibble()
  df <- apply(df, 2, as.character) %>% data.frame(stringsAsFactors = F)
  for(name in names(df)){
    df[, name] <- str_replace_all(df[,name], pattern = "list\\(\\)", replacement = "")
  }
  return(df)
}

# export mongodb as a data frame
mongo_to_df <- function(database){
  return(mongo_to_df_query(database, '{}'))
}

# print nongodb to a csv file  
mongo_to_csv <- function(database, file_name){
  df <- mongo_to_df(database)
  write.csv(df, file = file_name, row.names = F)  
}
```

# User data from mongodb
```{r User data from mongo db}
user_df <- mongo_to_df(db.user)
user_df <- user_df %>% rbind(mongo_to_df(db.userUnfetched))

user_df$followers <- user_df$followers %>% as.numeric()
user_df$following <- user_df$following %>% as.numeric()
user_df$public_repos <- user_df$public_repos %>% as.numeric()
user_df$public_gists <- user_df$public_gists %>% as.numeric()

user_readable_df <- user_df[,-c(3:16)]
```
# Where are those users

## Location Image

I this part, we 
```{r locationImage}
only_location <- user_readable_df %>% filter(location != "")
only_location <- only_location$location %>% toString() %>% 
  str_split(pattern = ",") %>% unlist %>% str_trim()
only_location <- data.frame(only_location) %>% 
  group_by(only_location) %>% count() %>% arrange(desc(n))

only_location %>% with(
  wordcloud(only_location, n, max.words = 100, colors=brewer.pal(8, "Dark2")))
```

## enerate locations
```{r}
user_with_location <- user_readable_df %>% filter(location != "")
user_with_location$location <- user_with_location$location %>% str_extract("^([^,|\\\\/])+") %>% unlist()
user_with_location <- user_with_location %>% group_by(location)
# This is location with number of people there
location_count <- user_with_location %>% count %>% arrange(desc(n))
# Top 20 location
top_location <- location_count %>% head(n = 20)
# Percentage of people from that location
top_location$percentage <- (top_location$n / user_with_location %>% nrow) %>% round(digits = 4) * 100

# Percentage of people in each location. Only top 15 locations are ploted
ggplot(data = top_location, 
       mapping = aes(x = reorder(location, -percentage), y = percentage, fill = location)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(size = 8, vjust = 1, hjust = 1, angle = 60)) +
  labs(x = "location", y = "percentage (%)") + 
  geom_text(aes(label = percentage), size = 3) +
  theme(legend.position="top")

# a pie chart of people in top 10 locations.
# NOTE: I just selected top 10 locations and draw them in a pie chart
#       It doesn't mean that all users are from those 10 locations.
#       As shown in the fisrt bar chart, the location with most pepole accounts for
#       about 5% of total people.
ggplot(data = head(top_location, 10), mapping = aes(x = factor(1), y = n, fill = location)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +
  theme_void()
```
bio info text mining
```{r}
bios <- user_readable_df$bio  %>% toString() %>% 
  str_remove_all("@|\\b[A-Z]\\b|\\b[A-Z]?[a-z]{1,3}\\b") %>%
  str_split("[ ,-]") %>% unlist %>% 
  str_remove_all(" |with|like|that|from|about|since|love|make|things|more|build|\\bs\\b|\\W|[0-9]+") %>% 
  str_trim() %>%
  tolower()
bios <- data.frame(bios, stringsAsFactors = FALSE) %>% 
  group_by(bios) %>% count() %>% arrange(desc(n))
bios[-1,] %>% with(wordcloud(bios, n, max.words = 50, colors=brewer.pal(8, "Dark2")))

ggplot(data = bios[-1,] %>% head(20), 
       mapping = aes(x = reorder(bios, -n), y = n, fill = bios)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(size = 8, vjust = 1, hjust = 1, angle = 60)) +
  labs(x = "Word In Bios", y = "Frequency")+
  theme(legend.position="top")
```
Catagorize people
```{r}
bio_df <- user_readable_df %>% filter(bio != "", company !="")
bio_df$university <- bio_df$company %>% str_detect("(C|c)ollege|(I|i)nstitute|(U|u)niversity|(S|s)chool|(A|a)cademy|.*U\\b|U.*\\b|UC|ETH|Tech|(S|s)tanford")
bio_df$professor <- bio_df$bio %>% str_detect("(P|p)rof(essor)?|prof\\.|(S|s)cientist|(r|R)esearcher")
bio_df$student <- bio_df$bio %>%
  str_detect("(S|s)tudent|(c|C)andidate|(p|P)\\.?(H|h)\\.?(d|D)\\.?")
bio_df$engineer <- bio_df$bio %>% 
  str_detect("(E|e)ngineer")
  
bio_df <- bio_df %>% select(university, professor, student, engineer, bio, company)


outlier <- function(df, variable_name){
  mean <- mean(df[,variable_name])
  threeSd <- sd(df[,variable_name]) * 3
  print(sprintf("mean: %f, sd: %f", mean, threeSd/3))
  df <- df %>% filter(df[variable_name] < mean + threeSd)
  df <- df %>% filter(df[variable_name] > mean - threeSd)
  df
}


  
outlier(following, "followers")

ggplot(data = follow_following) +
  geom_smooth(mapping = aes(x = followers, y = following))
```


